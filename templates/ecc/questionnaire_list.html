{% extends "base.html" %}
{% load static %}

{% block page_title %}
  Accueil - Mes espaces de dépôt
{% endblock page_title %}


{% block page_content %}
  <div class="row row-cards" id="questionnaire-list-vm">

      {% if user.profile.is_inspector %}
        <control-create></control-create>
      {% endif %}

      {% for control in controls reversed %}
        <div class="card" id="control-{{ control.id }}">
          <color-bar id="{{ control.id }}"></color-bar>
          <div class="card-header flex-column align-items-start">
            {% if control.depositing_organization %}
              <div class="page-title">Organisme interrogé : {{ control.depositing_organization }}</div>
              <div class="card-title">Procédure : {{ control.title }}</div>
            {% else %}
              <div class="page-title">{{ control.title }}</div>
            {% endif %}
          </div>
          <div class="card-body"> <!--// opening: questionnaire_description_card_body  //-->
            <div class="card border-0"> <!--// opening: list of questionnaires for control  //-->
              {% if control.questionnaires.count > 0 %}
                <div class="card">
                  <table class="table card-table table-vcenter">
                    <tbody>
                      {% for questionnaire in control.questionnaires.all %}
                        {% if user.profile.is_inspector or not questionnaire.is_draft %}
                          <tr {% if questionnaire.is_draft %} class="draft" {% endif %}>
                            <td>
                              <h5>
                                {% if questionnaire.is_draft %}
                                  <help-tooltip text="Les brouillons ne sont visibles que par l'équipe de contrôle, et sont modifiables."></help-tooltip>
                                  <span>[Brouillon]</span>
                                {% endif %}
                                <span>{{ questionnaire.title_display }}</span>
                              </h5>
                              {% if questionnaire.sent_date %}
                                <div><i class="fe fe-send"></i> Date de transmission du questionnaire :
                                  {{ questionnaire.sent_date|date:"l d F Y" }}
                                </div>
                              {% endif %}
                              {% if questionnaire.end_date %}
                                <div><i class="fe fe-clock"></i> Date de réponse souhaitée :
                                  {{ questionnaire.end_date|date:"l d F Y" }}
                                </div>
                              {% endif %}
                            </td>
                            <td class="w-1">
                              {% if user.profile.is_audited %}
                                <a href="{{ questionnaire.url }}"
                                   class="btn btn-primary"
                                   title="Déposer et consulter vos réponses"
                                >
                                  <i class="fe fe-eye"></i>
                                  Répondre
                                </a>
                              {% elif user.profile.is_inspector %}
                                {% if questionnaire.is_draft %}
                                  <a href="{% url 'questionnaire-edit' questionnaire.id %}"
                                     class="btn btn-primary"
                                     title="Modifier le brouillon de questionnaire"
                                  >
                                    <i class="fe fe-edit"></i>
                                    Modifier
                                  </a>
                                {% else %}
                                  <a href="{{ questionnaire.url }}"
                                     class="btn btn-primary"
                                     title="Consulter les réponses sur E-contrôle"
                                  >
                                    <i class="fe fe-eye"></i>
                                    Consulter
                                  </a>
                                {% endif %}
                              {% endif %}
                            </td>
                          </tr>
                        {% endif %}
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
              {% if user.profile.is_inspector %}
                <div>
                  <a href="{% url 'questionnaire-create' control.id %}" class="btn btn-primary">
                    <i class="fe fe-plus"></i>
                    Ajouter un questionnaire
                  </a>
                </div>
              {% endif %}
            </div> <!--// closing: list of questionnaires for control  //-->

            <users-for-control :control="{{ control.data }}" :key={{ control.id }}></users-for-control>

            <webdav-tip webdavurl="{{ settings.WEBDAV_URL }}/{{ control.reference_code }}"></webdav-tip>

          </div>  <!--// closing: questionnaire_description_card_body  //-->
        </div>
      {% endfor %}

    <add-user-modal></add-user-modal>

    <update-user-modal></update-user-modal>

    <remove-user-modal></remove-user-modal>

  </div>
{% endblock page_content %}

{% block js_bundle %}
  <script src="{% static 'dist/questionnaire-list-bundle.js' %}"></script>
{% endblock js_bundle %}
